In this section we will study:
- `PMAT-labs/labs/1-1.BasicStaticAnalysis/Malware.PackedAndNotPacked.exe.malz/Malware.PackedAndNotPacked.exe.zip`



When we talk about packed malware we are talking about malwares that contains pieces of code that are **compressed/encryped**.

This makes these pieces of code difficult to find and difficult to be identified by antiviruses.

So the malware is hidden in a section of the binary and it is then unpacked during the execution.
- It is very difficult to understand it using a static analysis.


Let's imagine to have a malware `malz.exe` and using `UPX` (a software) we pack the malware.

What UPX does is:
1. take a binary and compresses it
2. add to the compressed binary a decompressor (that is used on runtime to decompress the malware code)

So it takes the binary, adds a decompressor section (`stub`) and compresses the original code:
- ![[Pasted image 20250205162144.png]]
- at runtime it expands the code


## Why we do that?
Attackers use this technique to evade security scans and delay detection.

Antivirus programs rely on **signatures**—unique patterns of known malware—to identify threats. 
- However, when malware is packed, its code is compressed or altered, changing its appearance. 

Since the antivirus **only sees the packed version**, it may not recognize it as malicious. 

The real malware is only revealed after unpacking, which happens when the program is executed. 

# Analysis

## Unpacked malware
We open first in PEView the file:
- `Malware.NotPacked.exe.malz`

And we can see:
- ![[Pasted image 20250205162914.png]]
- ![[Pasted image 20250205163029.png]]
- **it has a normal structure and we can see all the Windows API calls**

## Packed malware
Now we can open:
- `Malware.Packed.exe.malz`

Here we can see interesting things:
- ![[Pasted image 20250205163301.png]]
- We have the section `UPX0` and `UPX1` that says to us the packer `UPX` is used to pack the code

If we take a look at the `Address Table` we can see:
- ![[Pasted image 20250205163426.png]]
- few calls (the malware ones are packed)
- but we can also see that there is the API call `LoadLibraryA` that is used to load dinamically a library (`.dll`) at runtime


Another thing we can see is that the `Sixe of Raw Data` is 0 and the `Virtual Size` is not 0:
- ![[Pasted image 20250205163755.png]]
- something is loaded at runtime


