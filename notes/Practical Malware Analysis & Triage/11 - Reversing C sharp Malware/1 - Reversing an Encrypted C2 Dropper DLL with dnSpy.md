In this section we will use:
- `PMAT-labs/labs/3-4.StaySharp-CSharpMalware/Malware.cryptlib64.dll.malz/Malware.cryptlib64.dll.malz.7z`

# Static analysis

## Floss
We start on extracting the strings using floss:
```powershell
 floss.exe Malware.cryptlib64.dll.malz > floss.txt 
```
- ![[Pasted image 20250212115418.png]]


We can see the `mscorelib` imported and also the version of `.NET Framework` so we can be quite sure is a `C#` application.
- ![[Pasted image 20250212115552.png]]

So we can use `dnspy` that is a tool used to study `.NET ` binaries
## dnspy
We open the file and we can see:
- ![[Pasted image 20250212115855.png]]
- so when the file was created it was called `EmbedDLL.dll`

We can also see we have 2 classes inside it:
- ![[Pasted image 20250212115950.png]]


In the class `Program` we can see that a text in base64 is decryptes with `AES` using a password ( `p0w3r0verwh3lm1ng!` ):
- ![[Pasted image 20250212120308.png]]

The result is then stored into the file `embed.xml`:
- ![[Pasted image 20250212120422.png]]

Then the malware converts a base64 into a string and to save the result into a file `embed.vbs` into the folder `C:\\Users\\Public\\Documents\\embed.vbs`:
- ![[Pasted image 20250212120520.png]]



The last part is used to write a key in the `Register` of Windows at `Software\Microsoft\Windows\CurrentVersion\Run`:
- ![[Pasted image 20250212121311.png]]

It seems to unpack a `vbs` script into the system.

So now we can use the tool `rundll32` to run functions contained into a `.dll` file

But first we have to remove `.malz` from the file:
- ![[Pasted image 20250212120846.png]]

# rundll32
So we run:
```powershell
rundll32 Malware.cryptlib64.dll,embed
```
- after `,`  we put the name of the function we want execute, we have seen it in `dnspy`

The result is:
- ![[Pasted image 20250212120935.png]]

We must have some files written in the OS in the folder `C:\Users\Public`:
- ![[Pasted image 20250212121014.png]]

At the same we must see something in `C:\Users\Public Documents`:
- ![[Pasted image 20250212121114.png]]


## Registers checking
We open the Registry Editor:
- ![[Pasted image 20250212121416.png]]

Here we go on `Computer\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`:
- ![[Pasted image 20250212121540.png]]

We can see the key for `embed`


# Files study
At this point we open `embed.xml` and `embed.vbs` into `VIsual Studio code.


In `embed.vbs` we can see that it runs `MSBuild.exe` with `embed.xml`:
- ![[Pasted image 20250212121812.png]]

So let's study `embed.xml` (`view` -> `word wrap):
- ![[Pasted image 20250212122004.png]]

So it decompresses a packed content and then runs it.


# Run fakenet
We run fakenet and we execute the malware. We can see we receive a request from a domain:
- ![[Pasted image 20250212122826.png]]
- so it can be a reverse shell

