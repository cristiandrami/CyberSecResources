In this section we will use:
- `PMAT-labs/labs/5-2.RuleWriting/Malware.yara1.exe.malz.7z`

We will use `yara` to write rules that are used to identify and classify malwares.

So we write rules in order to identify suspicious files looking at pattern such as strings, sequences of bytes and so on.

A `yara` rule is an expression that describes the characteristics of a file in order to identify it.

We have generally 3 sections:
1. Meta (optional) : description
2. Strings: text or binary strings that the files must contain
3. Condition: defines the logic to understand if a file matches the rule

*For example:*
```yara
rule Example_Malware_Detection
{
    meta:
        author = "Cybersec Researcher"
        description = "Rule to identify a malware"
        date = "2025-02-13"

    strings:
        $s1 = "malicious_function"   // suspicious string
        $s2 = {E8 ?? ?? ?? ?? 83 C4 10}  // a common signature in malwares
        $s3 = "http://malicious.com"  // malicious URL

    condition:
        any of ($s*)  // the file must contain at least one of that strings
}

```

*So if we have a file that contains at least one of that strings, then the file matches the rule and is identified as that specific malware.*




# Write yara rules
Just write the rules out of flare VM, because it could be possible we have to revert the vm,, so we will lose the rule.


We can install on visual studio code the extension `yara`.

At this point we create a file called `example.yara` and we write in it:
```python
rule Yara_example{
	meta:
		last_updated = "13-02-2025"
		
		author = "Cris"
		
		description = "A rule for examined malware"
	
	strings:
		$name = "string"
	
	
	condition:
		any of them
}
```
- we can use it as template
- ![[Pasted image 20250213163725.png]]

# Malware analysis

## Static analysis

We use floss on the malware:
- ![[Pasted image 20250213164046.png]]

It could be a good yara string for identifying this malware:
- ![[Pasted image 20250213164145.png]]

We also identify it is written in `nim` so we have in the strings:
- ![[Pasted image 20250213164239.png]]
So we put another string `nim`:
- ![[Pasted image 20250213164540.png]]


We use `xxd` on the file and we notice the `magic byte` of the `PE` file:
- ![[Pasted image 20250213164445.png]]
- it is `MZ`

We add it to the rule:
- ![[Pasted image 20250213164553.png]]


But this must be present in the first byte of the file so we add it into the condition:
- ![[Pasted image 20250213165005.png]]

 
