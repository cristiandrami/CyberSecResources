
In this section we will study:
- `PMAT-labs/labs/4-1.Bossfight-wannacry.exe/Ransomware.wannacry.exe.malz.7z`

We run it and it will encrypt everything in the system:
- ![[Pasted image 20250214104154.png]]

We can see also that it unpacked other files on the desktop:
- ![[Pasted image 20250214104224.png]]



So we revert the machine using the snapshot and we start to study it.

# Static analysis
## FLOSS
We run floss:
```powershell
floss.exe -n 8 
```


## PEstudio



# Dynamic analysis
## wireshark
We run the ransomware with `inetsim` executed and we can see it doesn't execute itself.

So we run wireshark on `REMnux` to see what happens.

At this point we run the malware as administrator:
- ![[Pasted image 20250214105006.png]]

On `REMnux` we can see a request to a strange domain:
- ![[Pasted image 20250214105040.png]]
- And `inetsim` replies with `200`


So if we close `inetsim` and we flush the dns on windows `ipconfig /flushdns` and we run the malware it runs itself.



## TCPview
It tries to connect to different hosts in the network:
- ![[Pasted image 20250214105659.png]]

It runs also a new process:
- ![[Pasted image 20250214105724.png]]


## PROCmon
We use procmon with 2 filters, one on the name and one on the file creation:
- ![[Pasted image 20250214105802.png]]

Then we run it as administrator:
- ![[Pasted image 20250214110014.png]]
- So it creates a file `tasksche.exe` into `C:\Windows`

In the process tree we can also see it runs this `.exe`:
- ![[Pasted image 20250214110144.png]]


So now we add the `parent pid` filter and the operation `create file`


We can see it create a directory in `C:\ProgramData\`:
- ![[Pasted image 20250214110405.png]]

It contains a lot of file used to execute the malware.



SO basically `tasksche.exe` is the second stage of the malware


## Task manager
SO now we open the task manager `CTRL + Alt + del/canc` and we can see a service with the exact name of the direcrtory created:
- ![[Pasted image 20250214110619.png]]


# Advanced Static analysis
Now we run `Cutter`:
- ![[Pasted image 20250214110700.png]]


If the outcome of the `InternetOpenUrl` is true:
- we stop the execution
- otherwise we call a function 
- ![[Pasted image 20250214110818.png]]


So now we open this function:
- ![[Pasted image 20250214110842.png]]
- this function is the rest of the encryption routine


# Advanced Dynamic analysis

## x32dbg analysis
AT this point we run `x64dbg`

here we `search for`-> `all modules` -> `String reference` and we put the starnge url:
- ![[Pasted image 20250214111206.png]]


We put a breakpoint here and then we run the program and we put `F9` to reach the breakpoint:
- ![[Pasted image 20250214111245.png]]


We reach the instruction `test edi,edi` and with `inetsim` open we can see the `ZF` flag is set to 0:
- ![[Pasted image 20250214111422.png]]
- this means the execution will be stop

So we change `ZF` to 1 and we force the running of the cryptographic procedure:
- ![[Pasted image 20250214111543.png]]
So this call is the call to the cryptographic procedure.