# Terminology
==**Malware** is short for "Malicious software", especially designed to harm user's computer or data==. 
- It is not a virus

==**Grayware/greyware** is somewhere between benign software and malware.==
- it is often labeled as potentially unwanted program or application (PUP/PUA) by antiviruses
- it is often labeled as potentially unwanted applications (PHA) by Google play store
- *examples: adware that shows intrusive adv, app with ability to root the phone*


# Malware types
We have different malwares that can be categorized based on:
- ==**propagation**==, how they replicates
	- Virus -> human-assisted propagation
	- Worm -> automatic propagation 
- ==**concealment**==, how it presents itself to the user
	- Trojan horse -> legitimate progam with hidden malicious behavio
	- Rootkit -> completely invisible to the user and hidden within the OS
- ==**functionality/payload**==, the type of activities it performs on the host system



## Common categories


1. **==Virus==** -> **self replicating program** 
2. **==Worm==** -> **self replicating program that propagates itself over the network**
3. **==Trojan==** -> **seems to be legitimate bu thas hidden malicious functionalities**
	1. *example: RAT (remote  access trojan) that open a backdoor on the system*
4. **==Rootkit==** -> **elevates its privileges to be hidden in the OS** 
	1. *example as a kernel driver*
5. **==Keylogger==** -> **records all keystrokes of the user on the keyboard**
6. **==Ransomware==** -> **encrypts user data and asks for a payment to obtain the private key to decrypt**
7. **==Spyware==** -> **steals confidential info and spies the user**
8. **==Adware==** -> **displays unwanted ads popups or hijacks the browser to inject unwanted ads**
9. **==Bot==** -> **gives to the attacker a control over the infected machine to perfrom arbitrary activities on command**
	1. *example: to perform DOS attacks*
10. **==Downloader==** -> **downloads and installs other malware**
11. **==Fileless Malware==** -> **stealthy malware that doesn't need to store persistent file on disk**

The list is not exhaustive!



![[Pasted image 20240523094319.png]]


# Who were behind malware in 80/90s?
Academics wanting to demonstrate what is technically possible, programmers wanting to prove their skills, prankster playing tricks on other people.


# Who is behind malware in now?
Organized cybercriminals.
Governments and intellicence for espionage.
Hacktivists for social or religious messages.

The motivation to that are:
1. ==**Data Theft and Espionage**==
2. **==Surveillance==**
3. **==Sabotage==** 
4. **==Resource Hijacking e Masquerading==**
	1. host or perform other criminal activities
	2. impersoante users/systems to launch attacks
5. ==**Extortion**==



# Traditional vs Targeted malware (APT)

Traditionally malware were designed to infect as many machines as possible to monetize them.

Now we have ==**Targeted Malwares or Advanced Persistent Threat (APT) that are directed to business of political targets**==:
- constructed to stay as stealthy as possible and to stay active for a long period. *Example APT41 -> created by China government*


# Economic incentives

We have to consider that infected devices can be monetized:
- stealing and selling sensitive infos
- selling the access to the device (for DDOS attacks, cryptomining etc)
- asking for money to decrypt data infected by ransomware

*Example of monetization for Ransomware*:
![[Pasted image 20240523095541.png]]

# Political incentives
**==For the political purposes we can have malwares for espionage and cyber-warfare targeted towards...==**

*Examples: surveillance of minorities or political opponents, spreading fake news and misinformation, leaking confidential info etc*


## Example of Espionage and Sabotage: Stuxnet
![[Pasted image 20240523095810.png]]

It was developed by US and israel government to sabotage nuclear program by damaging centrifuges.

### How does it work?
1. infection via usb
2. check if the infected device could be a machine used for nuclear stuff
	1. if not just update itself for new versions of the malware
3. compromise the logic controllers exploiting zero day vulnerabilities
4. control, initially the malware gains info on the centrifuges, then takes control of them in order to make them fail
5. meanwhile false feedback are provided 

## Example of surveillance: Insomnia
![[Pasted image 20240523100248.png]]

It is a spyware constructed by chinese authorities for political opponents, dissidents or minorities.




# Malware distribution

We have different ways to distribute a malware:

1. **==Self propagation==** -> **worms moves pc to pc over the network**
2. **==Physical media==** -> **USB drives taking advantage of autorun that executes a executable when the usb is plugged in, connecting the pc to a mobile device**
3. **==Supply chain attacks==** 
	1. infected build system or compiler that infects all application
	2. malwares pre installed in the system image as rootkit
	3. hardware trojans
4. ==**Social engineering**== 
	1. installing cracked software, license key generator 
	2. phishing attacks
	3. spear phishing attacks, phishing but targeted
5. **=Drive by download=** 
	1. malware exploiting browser vulnerabilities when the user visits a compromised website
	2. links can be distributed through various means


## Maximizing the infections: Installation chains

==**In general the idea is to infect an entry point in order to infect other stuff later.**==

<mark style="background: #FF5582A6;">Generally this infection is completely hidden and is used to inject new payloads later.</mark>

*Example: Emoter-Trickbot-Ryuk attack*
![[Pasted image 20240523101242.png]]

# Botnet command and control

## Botnets

<mark style="background: #FF5582A6;">Nowadays malware infect hosts and turns them into a bot that waits for command from its botmaster.</mark>

The botmaster can:
- send mantainance and updates 
- send other malicious payloads
- send malicious commands


### Common botnet activities
We can have DDoS attacks, sending of spam or phishing emails, sending new malwares, mass identity theft, keylogging etc


## Command and control (C&C)
<mark style="background: #BBFABBA6;">The main defense against botnets is to preventing the communication.</mark>

==**The idea is to redirect the network traffic to a server under their control playing with the DNS:**==
- change the domain registration 
- <mark style="background: #BBFABBA6;">intercept and modify DNS requests at the ISP-level, on the firewall or directly on the infected host</mark>


### C&C resilience mechanisms

They can have the ==**bulletproof hosting**, because some domain companies are known for their lenience (indulgenza) on their customers and sometimes are located in jurisdictions 
not easily accessible by law enforcement.==
- quindi hanno un hosting che non si interessa delle attività illecite che vengono svolte con i domini

Then they can also use the ==**Fast flux** technique==, where:
- **==the domain name is assigned to a large number of different IP, so it is not possible to locate the machines==**
- they use round robin DNS with very short TTL (time to live) less than 5 iìminutes

But the intersting thing is the ===**Domain Generation Algorithms (DGA)** that generates pseudo random domain names that are only valid for a short period of time===
- they depends on secret seeds shared with the bot master, that is an hardcoded, the date and the time on which the domain can be valid and so on
- we could detect them by a large of Non-Existent Domain `NXDOMAIN` since the DGA sends a lot of query to unregistered ones
- quindi qui faccio collegare il bot ad un dominio sempre diverso

![[Pasted image 20240523102504.png]]



# Malware analysis and defenses

## Goals of malware analysis
The idea is to use the **defensive reverse engineering** to reverse a malware and understand the functionality, origin and potential impact of a given sample.


## Analysis techniques

### Static analysis 
<mark style="background: #BBFABBA6;">The idea here it to examine the malware code without executing it.</mark>

It involves the usage of decompiling or disassembling.

It provides an overview about meta information from files, code protections, interesting strings, instruction sequences, hex codes etc.

In addition it provides a roadmap for dynamic analysis.

But we have some drawbacks:
- <mark style="background: #FF5582A6;">the binary code typically contains very little semantics</mark>
- <mark style="background: #FF5582A6;">complicated by obfuscation and packing</mark>
- <mark style="background: #FF5582A6;">defeated by dynamically loaded components</mark>



### Dynamic analysis
<mark style="background: #BBFABBA6;">The idea here is to monitor the behavior during the malware running, in a controlled and isolated environment.</mark>

It is also possible to use a debugger or using an automated approach.

<mark style="background: #BBFABBA6;">In general it gives us the possibility to observe the unpacked code and the executed instructions or to observe system calls, network behavior and general effects on the system.</mark>

The drawbacks here are:
- <mark style="background: #FF5582A6;">we can only observe a code path at a time</mark>
- <mark style="background: #FF5582A6;">the analysis of the envoronment cannot be complete</mark>
- <mark style="background: #FF5582A6;">the analysis of the environment might be not transparent</mark> (maybe the environment sensitive malwares can evade the analysis)


## Analysis precautions
When analyze a malware, always ==avoid to infect yourself by using **sandbox** and avoid to infect others by **limiting network-access, rate the limit connection to avoid DoS or perform the analysis in a fully isolated network.**==


Instructions and already prepared virtual machines are e.g., available here: 
- https://malwareunicorn.org/workshops/re101.html#2 
- https://remnux.org
- https://github.com/fireeye/flare-vm



## Analysis resources
We have a lot of resources like:

Online analysis sandboxes:
- Any.Run Interactive Sandbox: https://any.run 
- VirusTotal: https://www.virustotal.com
- Avast APKlab (specifically for Android apps): https://www.apklab.io


Open source analysis sandboxes to set up yourself:
- Cuckoo https://cuckoosandbox.org 
- Drakvuf https://drakvuf.com 
- PANDA (Platform for Architecture-Neutral Dynamic Analysis) https://panda-re.mit.edu

But in general a list of tools can be found there:
- https://github.com/rshipp/awesome-malware-analysis



## YARA
It is a popular open source <mark style="background: #BBFABBA6;">tool for generating and sharing strings/pattern/signature called "rules" about specific malware samples or more general capabilites and features</mark>.
- https://virustotal.github.io/yara/ 
- Integrated with many other services, rules can be generated automatically 
- Official rules: https://github.com/Yara-Rules/rules 
- More resources & rules: https://github.com/InQuest/awesome-yara

![[Pasted image 20240523105257.png]]


## IOCs

Analysis generally extract ==**Indicators of compromise (IOCs)** that include file hashes (SHA256), IP addresses, domain names, URLs.==

These info can be shared as part of public and commercial "threat intelligence".



## How does antiviruses work?

Basically they are based on:
- **==signature-based==** -> **analysis on collected malwares, where a signature is a set of bytes considered to be unique to a malware (like yara rules)**
	- at runtime the AV scan the file with the data in the DB
- **==Behavior-based==** -> **on runtime AV uses behavioral heuristics to identify potential dangerous behavior by intercepting and monitoring system calls**
- **==Machine learning based==**


Next-gen AV use Ml to detect malwares., but we have a certain number of problems:
1. ML is generally black-box and not explainable
2. ML can be easily hustled by data changing
3. ML is based on static analysis 



# Anti analysis techniques

Malware is probably the most protected software that you'll ever try to analyze.

## Techniques against Static Analysis

**==Obfuscation==** -> **transforms the source or binary code in a way that is functionally equivalent but harder to understand by a human and confuses or breaks commonly used static analysis tool.**
- it includes instruction substitution, changing the control flow, inserting dead or junk code 


<mark style="background: #FF5582A6;">Packers</mark> -> **compress and or encrypt an executable and decrypt or decompress in a dynamic way during the execution**
- generally not applicable by hand but as part of freely availble or commercial software protectors.
	- UPX is open source https://upx.github.io
	- customized by malware authors, hard to detect and unpack (Hint: Use hex code editors, https://github.com/WerWolv/ImHex)


![[Pasted image 20240523121808.png]]



## Patching defensive mechanisms

**==Malware can detect via GetTickCount that it is being debugged.==** 
- when the execution is to slow, generally because we are debugging it

Or **==it can use also other APIs==** -> **IsDebuggerPresent, CheckRemoteDebuggerPresent, RDTSC (Read Time-Stamp Counter) assembly instruction**

<mark style="background: #BBFABBA6;">To bypass these protections we have to patch the malware code and so editing the assembly code:</mark>
- *example: remove the jump instruction of the check*



## Defense and obfuscation

### XOR 
Malware authors attempt to hide sensitive strings as IP addresses, URLs.
**==One strategy is the XOR operation in which 1-byte key value XORs each character of the original string with the key.==**

These tools can help us to decode xored strings:
- Xortool : https://github.com/hellman/xortool 
- Kahu tools : https://www.kahusecurity.com/tools.html
- Xorbruteforcer : https://eternal-todo.com/var/scripts/xorbruteforcer 
- FLOSS : https://www.mandiant.com/resources/automatically-extracting-obfuscated-strings

### Stack strings 
In this technique the idea is to use various MOV instructions to manually construct strings byte per byte

**==The MOV instruction places 1-byte value at consecutive memory location. Each byte refers to a char of the string.==**

The string is constructed dynamically on runtime.


With ghidra we can decode them:
![[Pasted image 20240523123001.png]]


### TLS callbacks functions
 **==A TLS (thread local storage) is used to call a subrutine that are executed before the entry point of a function.==** 
 - so when we call a function **windows** execute it before the entry point instruction of the function 

A section of the PE header describes the place of a TLS callback.
- **==In windows il PE header (header del file eseguibile) contiene diverse sezioni che descrivono le caratteristiche e i comportamenti del file==**

A programmer can define TLS callback functions (that were defined to intialize and clear TLS data objects)

![[Pasted image 20240523123241.png]]



#### How malware authors exploit it?
Malware authors use them to confuse analysts and debugging tools regarding the beginning of the code.

**==They allow malware authors to execute code before the debugger pauses at the traditional entry point.==** 


Example:
![[Pasted image 20240523124023.png]]

The idea is to disassemble the callback.


*example with ghidra*:
![[Pasted image 20240523124044.png]]

![[Pasted image 20240523124054.png]]
- Ghidra says to us that something is strange, because a TLS callback could not execute code




### Debugging by anticipating actions
NanoLocker is a ransomware usually delivered by spam emails and may be downloaded from compromised websites.

In general ransomware variants use same functional approach
1. **uses the Wondows CryptoAPI for cryptographic operations**
2. **enumerate all files from C to Z drive**
3. **uses FindFirstFile / FindNextFile to continue the file search**

![[Pasted image 20240523124802.png]]



## Advanced techniques

**==Process injection==** -> **in which the malware code is injected into another process**
- example the unpacker injects decoded code into another process instead of injecting it in his memory space
- **the code is executed into a legitimate program**

**==API Hooking==** -> **the malware modifies the call flow of APIs.**
- hooks can be used to spy victims 
- **it allows the malware to monitor system interactions** 

**==Process hollowing==** -> **a legitimate process is charged in the system only for injecting in it the malicious code**
- a legitimate process is created, the code of it is substituted with the malicious one

**==Structured Exception Handling (SEH)==** -> **to avoid debugging malware trigger exceptions and executes malware code in them**








# Summary

## Reasons for Malware Prevalence: The Technical Stuff

==**Mixing of data and code such as pdf.**==

**==Homogeneous computing base==** -> **Windows is the first targeted system such as android** 

**==Systems are online 24/7 especially smartphones.==**

**==PEPKAC (Problem Exists Between Keyboard And Chair)==** -> **trojans and phishing attacks that exploit human behavior are hard to prevent**

Malicious code is profitable


# Further Reading & Hands-On Tutorials

Malware Unicorn Reverse Engineering 101 & 102, Anti-Analysis Techniques
- https://malwareunicorn.org/#/workshops 

Maddie Stone’s Android App Reverse Engineering 101 (not specific to malware, but includes obfuscation, see also mobile security materials)
- https://ragingrock.com/AndroidAppRE/

Richard, Hartstein, Adair, Ligh: Malware Analyst’s Cookbook: Tools and Techniques for Fighting Malicious Code Code 
- examples: https://github.com/mgoffin/malwarecookbook 

Sikorski, Honig: Practical Malware Analysis Code 
- examples: https://github.com/rikonaka/PracticalMalwareAnalysis-Labs-Sample 

Saxe, Sanders: Malware Data Science Code 
- examples: https://www.malwaredatascience.com/code-and-data 

Take part in online competitions (or try your hand on past challenges): 
- Flare-On RE Challenge
	- http://flare-on.com https://www.fireeye.com/blog/threat-research/2020/10/flare-on-7-challenge-solutions.html 
- Microsoft regularly hosts challenges attacking and defending ML-based malware detection approaches
	- https://www.kaggle.com/c/microsoft-malware-prediction 
	- https://mlsec.io

# Useful Tools for Windows Malware Analysis

x64dbg An open-source x64/x32 debugger for windows PE 
- https://x64dbg.com 

ILSpy An open-source .NET assembly browser and decompiler 
- https://github.com/icsharpcode/ILSpy 

FLARE VM "The Windows Malware Analysis Distribution You’ve Always Needed!"
- https://www.mandiant.com/resources/blog/flare-vm-thewindows-malware 

procmon An advanced monitoring tool for Windows that shows real-time file system, registry and process/thread activity 
- https://learn.microsoft.com/en-us/sysinternals/downloads/procmon 

CFF Explorer to analyze sample’s imports, resources, and PE header structure 
- https://forum.reverse4you.org/t/cff-explorer-is-a-suite-of-toolsfor-portable-executable-pe-editing/17134


# Where to get samples to practice your RE skills?

theZoo 
- https://thezoo.morirt.com https://github.com/ytisf/theZoo

MalwareBazaar 
- https://bazaar.abuse.ch 

Contagio Malware Dump 
- https://contagiodump.blogspot.com 

VirusShare 
- https://virusshare.com

Full list: 
- https://github.com/rshipp/awesome-malware-analysis#malware-corpora
